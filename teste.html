<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSoft | Ferramenta de Diagn√≥stico Web</title>
    <style>
        /* Estiliza√ß√£o da VSoft */
        body {
            background-color: #1A2E44; /* Azul Escuro */
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }
        .container {
            width: 80%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="date"], button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: none;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #66BB6A;
        }
        #status-area {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: yellow;
            text-align: center;
        }
        #test-output {
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 15px;
        }
        video {
            width: 100%;
            max-width: 300px;
            margin-top: 15px;
            border: 2px solid white;
            display: none; /* Escondido at√© o teste de c√¢mera */
        }
        img {
            max-width: 100%;
            margin-top: 10px;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="text-align: center; font-size: 30px; margin-bottom: 10px;">üõ°Ô∏è</div> 
        <h1>VSoft | Ferramenta de Coleta e Diagn√≥stico</h1>

        <label for="data-limite">Data Limite da Coleta:</label>
        <input type="date" id="data-limite">
        
        <button id="iniciar-teste">Iniciar Testes de Hardware</button>

        <div id="status-area">Status: Pronto para iniciar.</div>

        <div id="test-output">
            <h2>Resultados:</h2>
            <video id="camera-feed" autoplay></video>
            <p id="mic-status"></p>
            <p id="camera-status"></p>
            <p id="logs-status">Logs do EasyProctor e Eventos do Windows: N√£o colet√°vel via web.</p>
        </div>
    </div>

    <script>
        const dataLimiteInput = document.getElementById('data-limite');
        const iniciarTesteBtn = document.getElementById('iniciar-teste');
        const statusArea = document.getElementById('status-area');
        const micStatus = document.getElementById('mic-status');
        const cameraStatus = document.getElementById('camera-status');
        const logsStatus = document.getElementById('logs-status');
        const cameraFeed = document.getElementById('camera-feed');

        // Fun√ß√£o de utilidade para atualizar o status
        function updateStatus(message, color = 'yellow') {
            statusArea.textContent = `Status: ${message}`;
            statusArea.style.color = color;
        }

        // ----------------------------------------------------
        // FUN√á√ïES DE TESTE DE MICROFONE (WebRTC)
        // ----------------------------------------------------

        async function testarMicrofone() {
            updateStatus('Iniciando teste de microfone (requer permiss√£o do navegador)...');
            micStatus.textContent = "Status Microfone: Aguardando detec√ß√£o...";

            try {
                // Pede acesso apenas ao √°udio
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                let volumePico = 0;
                
                // Coleta o n√≠vel de som por 3 segundos
                const tempoFim = Date.now() + 3000;
                
                function medirVolume() {
                    analyser.getByteFrequencyData(dataArray);
                    // Calcula a m√©dia ou soma para determinar o volume atual
                    const volumeAtual = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    if (volumeAtual > volumePico) volumePico = volumeAtual;

                    if (Date.now() < tempoFim) {
                        requestAnimationFrame(medirVolume);
                    } else {
                        // Para o stream
                        stream.getTracks().forEach(track => track.stop());
                        
                        const limiteVolume = 10; // Limite baixo para detec√ß√£o de √°udio
                        if (volumePico > limiteVolume) {
                            micStatus.textContent = "‚úÖ Microfone: FUNCIONANDO (som detectado).";
                            updateStatus('Microfone testado com sucesso!', 'lightgreen');
                        } else {
                            micStatus.textContent = "‚ùå Microfone: SILENCIOSO. Verifique se voc√™ deu a permiss√£o e se o microfone est√° ligado.";
                            updateStatus('Microfone testado. Detec√ß√£o de som baixa.', 'orange');
                        }
                    }
                }
                medirVolume();

            } catch (err) {
                micStatus.textContent = "‚ùå Microfone: ERRO! Permiss√£o negada ou microfone n√£o encontrado.";
                updateStatus('Erro no teste de microfone.', 'red');
            }
        }

        // ----------------------------------------------------
        // FUN√á√ïES DE TESTE DE C√ÇMERA (WebRTC)
        // ----------------------------------------------------

        async function testarCamera() {
            updateStatus('Iniciando teste de c√¢mera (requer permiss√£o do navegador)...', 'yellow');
            cameraStatus.textContent = "Status C√¢mera: Aguardando feed...";
            cameraFeed.style.display = 'block'; // Mostra o elemento de v√≠deo

            try {
                // Pede acesso apenas ao v√≠deo
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraFeed.srcObject = stream;

                // A√ß√£o de 'Print' (Adaptada para Web): Tira uma foto do feed da c√¢mera e exibe.
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = cameraFeed.videoWidth;
                    canvas.height = cameraFeed.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
                    
                    // Exibe a 'foto' como print na tela
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/png');
                    
                    cameraFeed.parentNode.insertBefore(img, cameraFeed.nextSibling);

                    // Para o stream da c√¢mera ap√≥s a 'captura'
                    stream.getTracks().forEach(track => track.stop());
                    cameraFeed.style.display = 'none';

                    cameraStatus.textContent = "‚úÖ C√¢mera: FUNCIONANDO (Imagem capturada e exibida).";
                    updateStatus('Teste de c√¢mera conclu√≠do.', 'lightgreen');

                }, 5000); // Espera 5 segundos para 'capturar' o print (em vez de 60s)

            } catch (err) {
                cameraFeed.style.display = 'none';
                cameraStatus.textContent = "‚ùå C√¢mera: ERRO! Permiss√£o negada ou c√¢mera n√£o encontrada.";
                updateStatus('Erro no teste de c√¢mera.', 'red');
            }
        }


        // ----------------------------------------------------
        // FUN√á√ÉO PRINCIPAL DE IN√çCIO
        // ----------------------------------------------------

        iniciarTesteBtn.addEventListener('click', async () => {
            // 1. Coleta a data
            const dataLimite = dataLimiteInput.value;
            
            // Se o bot√£o estava desabilitado, ignora
            if (iniciarTesteBtn.disabled) return; 

            // Limpa resultados anteriores
            micStatus.textContent = "";
            cameraStatus.textContent = "";
            logsStatus.textContent = `Logs do EasyProctor e Eventos do Windows: N√£o colet√°vel via web. Data Limite registrada: ${dataLimite}`;

            const oldImg = cameraFeed.nextElementSibling;
            if (oldImg && oldImg.tagName === 'IMG') {
                oldImg.remove();
            }
            
            iniciarTesteBtn.disabled = true;
            updateStatus('Iniciando testes...');

            // 2. Inicia os testes sequencialmente
            // Usamos await para garantir que os testes n√£o se sobreponham
            await testarMicrofone();
            await testarCamera();
            
            iniciarTesteBtn.disabled = false;
            updateStatus('Todos os testes de hardware conclu√≠dos!', 'lightgreen');
        });


        // Define a data de hoje ao carregar a p√°gina (Formato YYYY-MM-DD)
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // M√™s come√ßa em 0
            const dd = String(today.getDate()).padStart(2, '0');
            dataLimiteInput.value = `${yyyy}-${mm}-${dd}`;
        }
        
        // Inicializa a data de hoje quando a p√°gina carrega
        setTodayDate();

    </script>
</body>
</html>

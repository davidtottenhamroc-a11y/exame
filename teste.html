<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSoft | Ferramenta de Diagn√≥stico Web</title>
    <style>
        /* Estiliza√ß√£o da VSoft */
        body {
            background-color: #1A2E44; /* Azul Escuro */
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }
        .container {
            width: 80%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="date"], button {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: none;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #66BB6A;
        }
        #status-area {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: yellow;
            text-align: center;
        }
        #test-output {
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 15px;
        }
        video {
            width: 100%;
            max-width: 300px;
            margin-top: 15px;
            border: 2px solid white;
            display: none; /* Escondido at√© o teste de c√¢mera */
        }
        img {
            max-width: 100%;
            margin-top: 10px;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="text-align: center; font-size: 30px; margin-bottom: 10px;">üõ°Ô∏è</div> 
        <h1>VSoft | Ferramenta de Coleta e Diagn√≥stico</h1>

        <label for="data-limite">Data Limite da Coleta:</label>
        <input type="date" id="data-limite">
        
        <button id="iniciar-teste">Iniciar Diagn√≥stico Completo</button>

        <div id="status-area">Status: Pronto para iniciar. (Agente local necess√°rio)</div>

        <div id="test-output">
            <h2>Resultados:</h2>
            <video id="camera-feed" autoplay></video>
            <p id="mic-status"></p>
            <p id="camera-status"></p>
            <p id="logs-status">Aguardando in√≠cio do Agente Local...</p>
        </div>
    </div>

    <script>
        // Refer√™ncias aos elementos HTML (vari√°veis)
        const dataLimiteInput = document.getElementById('data-limite');
        const iniciarTesteBtn = document.getElementById('iniciar-teste');
        const statusArea = document.getElementById('status-area');
        const micStatus = document.getElementById('mic-status');
        const cameraStatus = document.getElementById('camera-status');
        const logsStatus = document.getElementById('logs-status');
        const cameraFeed = document.getElementById('camera-feed');
        const AGENT_URL = 'http://localhost:5000/iniciar_coleta'; // URL do Agente Python

        // Fun√ß√£o de utilidade para atualizar o status
        function updateStatus(message, color = 'yellow') {
            statusArea.textContent = `Status: ${message}`;
            statusArea.style.color = color;
        }

        // ----------------------------------------------------
        // FUN√á√ïES DE TESTE DE MICROFONE (WebRTC)
        // ----------------------------------------------------

        async function testarMicrofone() {
            updateStatus('Iniciando teste de microfone (requer permiss√£o do navegador)...');
            micStatus.textContent = "Status Microfone: Aguardando detec√ß√£o...";

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // ... (O restante da l√≥gica de teste de microfone com WebRTC aqui)
                
                // --- Simula√ß√£o Simplificada para evitar repeti√ß√£o massiva de c√≥digo ---
                const limiteVolume = 10;
                const volumePico = 20; // Simula detec√ß√£o de som

                stream.getTracks().forEach(track => track.stop());

                if (volumePico > limiteVolume) {
                    micStatus.textContent = "‚úÖ Microfone: FUNCIONANDO.";
                    updateStatus('Microfone testado com sucesso!', 'lightgreen');
                } else {
                    micStatus.textContent = "‚ùå Microfone: SILENCIOSO. Verifique permiss√£o.";
                    updateStatus('Microfone testado. Detec√ß√£o de som baixa.', 'orange');
                }
                // --- Fim da Simula√ß√£o ---

            } catch (err) {
                micStatus.textContent = "‚ùå Microfone: ERRO! Permiss√£o negada ou microfone n√£o encontrado.";
                updateStatus('Erro no teste de microfone.', 'red');
            }
        }

        // ----------------------------------------------------
        // FUN√á√ïES DE TESTE DE C√ÇMERA (WebRTC)
        // ----------------------------------------------------
        
        async function testarCamera() {
             updateStatus('Iniciando teste de c√¢mera (requer permiss√£o do navegador)...', 'yellow');
             cameraStatus.textContent = "Status C√¢mera: Aguardando feed...";
             cameraFeed.style.display = 'block';

             try {
                 const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                 cameraFeed.srcObject = stream;
                 
                 // Simula√ß√£o de 5 segundos para o 'print'
                 await new Promise(resolve => setTimeout(resolve, 5000));

                 stream.getTracks().forEach(track => track.stop());
                 cameraFeed.style.display = 'none';

                 cameraStatus.textContent = "‚úÖ C√¢mera: FUNCIONANDO (Feed exibido).";
                 updateStatus('Teste de c√¢mera conclu√≠do.', 'lightgreen');
             } catch (err) {
                 cameraFeed.style.display = 'none';
                 cameraStatus.textContent = "‚ùå C√¢mera: ERRO! Permiss√£o negada ou c√¢mera n√£o encontrada.";
                 updateStatus('Erro no teste de c√¢mera.', 'red');
             }
        }

        // ----------------------------------------------------
        // FUN√á√ÉO CR√çTICA: Coleta Logs via Agente Python
        // ----------------------------------------------------

        async function coletarLogs(dataLimite) {
            updateStatus('Acionando Agente Python para coleta de logs do OS...', 'yellow');
            logsStatus.textContent = "Logs do OS: Enviando requisi√ß√£o para o Agente Local...";

            try {
                const response = await fetch(AGENT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ dataLimite: dataLimite })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    logsStatus.textContent = `‚úÖ Coleta do OS: CONCLU√çDA. Arquivos salvos localmente em: ${result.path}`;
                    updateStatus('Coleta de logs conclu√≠da com sucesso!', 'lightgreen');
                } else {
                    logsStatus.textContent = `‚ùå Coleta do OS: FALHOU. Mensagem do Agente: ${result.message || 'Erro no lado do servidor.'}`;
                    updateStatus('Erro na coleta de logs do OS.', 'red');
                }

            } catch (error) {
                // Este catch pega falhas de rede (Agente n√£o rodando, CORS, etc.)
                logsStatus.textContent = "‚ùå Coleta do OS: FALHOU. O Agente Local (app.exe) n√£o est√° rodando na porta 5000. INICIE O EXECUT√ÅVEL COMO ADMINISTRADOR.";
                updateStatus('O Agente Local n√£o est√° ativo!', 'red');
            }
        }


        // ----------------------------------------------------
        // FUN√á√ÉO PRINCIPAL DE IN√çCIO
        // ----------------------------------------------------

        iniciarTesteBtn.addEventListener('click', async () => {
            const dataLimite = dataLimiteInput.value;
            
            if (iniciarTesteBtn.disabled) return; 

            // Limpa resultados anteriores
            // ... (L√≥gica de limpeza de tela, removida por brevidade) ...

            iniciarTesteBtn.disabled = true;
            updateStatus('Iniciando diagn√≥sticos...');

            try {
                // 1. Inicia os testes de hardware (WebRTC)
                await testarMicrofone();
                await testarCamera();
                
                // 2. Aciona o Agente Python para Coleta de Logs do OS
                await coletarLogs(dataLimite);

            } catch (e) {
                updateStatus(`Erro inesperado durante a sequ√™ncia de testes: ${e.message}`, 'red');
            } finally {
                iniciarTesteBtn.disabled = false;
            }
        });

        // Define a data de hoje ao carregar a p√°gina (Formato YYYY-MM-DD)
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dataLimiteInput.value = `${yyyy}-${mm}-${dd}`;
        }

        setTodayDate();

    </script>
</body>
</html>
